name: Deploy React Blog to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:   # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3   # stable & widely used version
        # Alternative (auto-updates to latest v1 patch): appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}     # ← uncomment only if your key has passphrase
          port: 22
          timeout: 30s
          command_timeout: 600s   # 10 minutes
          debug: true             # Remove or set to false once working

          script: |
            set -e

            echo "Starting deployment at $(date '+%Y-%m-%d %H:%M:%S IST')"

            cd ${{ secrets.PROJECT_PATH }} || { echo "Error: Directory ${{ secrets.PROJECT_PATH }} not found"; exit 1; }

            echo "Current working directory: $(pwd)"
            echo "Current git branch: $(git branch --show-current)"

            # Fetch latest and reset to match remote main (clean update)
            git fetch origin
            git reset --hard origin/main

            # Only install if dependencies changed
            if git diff --name-only HEAD^ HEAD | grep -qE 'package\.json|package-lock\.json'; then
              echo "package.json or lockfile changed → installing dependencies"
              npm ci --prefer-offline --no-audit --progress=false
            else
              echo "No dependency changes detected"
            fi

            echo "Restarting the application..."
            pm2 restart simple-blog || { echo "pm2 restart failed - check pm2 logs"; exit 1; }

            # Save pm2 process list (survives reboots)
            pm2 save

            echo "Deployment finished successfully"
            echo "Latest commit: $(git rev-parse --short HEAD)"
            echo "Done at $(date '+%Y-%m-%d %H:%M:%S IST')"